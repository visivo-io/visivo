# V2 Spec

name: V2

groups:
  - name: Executives
    emails:
      - ceo@visivo.io
      - cto@visivo.io

conditions:
  - name: if_during_business_hours
    logic: if now() < 16:00 && now() > 08:00
  - name: if_production
    logic: if env == production
  - name: if_morning_notifications
    logic: if env["MORNING_NOTIFICATION"] == true

alerts:
  - name: Failure During Business Hours
    condition: if_during_business_hours
    message: |
      Trigger {{ trigger.name }} has failed
    destinations:
      - type: slack
        webhook_url: https://slack.com
  - name: Once a Day Alert
    condition: if_morning_notifications
    # We could move toward a {{ }} syntax for dynamic content
    message:
      | # This could be optional and default to what we had.  I think being able to format the message is key.  How are we going to reference the test failure data.
      Trigger {{ context.name }} has failed.
      {{ context.test }} Values
    destinations:
      - type: slack
        webhook_url: https://slack.com
      - type: email
        email: alert@visivo.io

traces:
  - name: Meta Trace
    model: Meta Model
    columns:
      y: [[x]]
    props:
      type: scatter
      x: [[x]]
      y: {{ trace.columns.y }}
    filters:
      - [[x > 0]]

    meta:
      data-grain: daily # this doesn't allow us to choose the cohort_on information
    test_suites:
      - name: operation_report
        condition: if_production # should this be a list? conditions?
        tests:
          - logic: assert_that( len( {{ trace.props.marker.line.color[1] }} ).is_equal_to("#d25946")
        on_failure: continue
        alerts:
          - Once A Day Alert

      - name: production
        condition: if_production
        tests:
          - logic: assert_that( {{ Meta Trace.props.marker.line.color[1] }} ).is_equal_to("#D25946")
        on_failure: exit # or continue
        alerts:
          - Failure During Business Hours

selectors: # Selectors select the grain.
  - name: Meta Selector
    default: day
    options:
      - label: day
        matcher: trace.meta.date-grain == "daily" || cohort.name == "daily" # We need a consistent way to have python logic statements
      - label: week
        matcher: trace.meta.date-grain == "weekly" || cohort.name == "weekly"
      - title: month
        matcher: trace.meta.date-grain == "monthly" || cohort.name == "monthly"

dashboards:
  - name: Restricted
    permissions: # I can't think of a use case that we would actually want to exclude a group. The easiest is to do "if in any". Maybe call this something else.
      - Executives
      - Finance

  - name: Open
