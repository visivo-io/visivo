name: "Release"

on:
  workflow_dispatch:
    inputs:
      version:
        required: true

jobs:
  create-release:
    name: "CreateRelease"
    runs-on: "ubuntu-latest"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
      
      - name: Setup Poetry
        uses: Gr1N/setup-poetry@v9
      
      - name: Build App
        run: |
          cd viewer && yarn install && yarn deploy && cd ..
          poetry version ${{ inputs.version }}

      - name: Commit changes
        uses: EndBug/add-and-commit@v9
        with:
          author_name: Visivo
          author_email: info@visivo.io
          message: 'Build viewer for Python package'
     
      - name: Add and push tag
        run: |
          git tag -a "v${{ inputs.version }}" -m "Release v${{ inputs.version }}"
          git push origin "v${{ inputs.version }}"

      - uses: "marvinpinto/action-automatic-releases@latest"
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          automatic_release_tag: "v${{ inputs.version }}"
          prerelease: false
        
      - uses: "marvinpinto/action-automatic-releases@latest"
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          automatic_release_tag: "latest"
          prerelease: true
          title: "Latest versioned release"

      - name: Publish
        id: publish
        run: |
          poetry config pypi-token.pypi ${{ secrets.PYPI_TOKEN }}
          poetry build
          poetry publish 

      - name: Trigger Core Deployment
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.CORE_DEPLOY_TOKEN }}
          repository: visivo-io/core
          event-type: visivo-release